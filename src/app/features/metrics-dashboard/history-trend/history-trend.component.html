<!-- Historical Trend Line Panel -->
<section
  *ngIf="shouldShow()"
  class="history-trend"
  [class.reduced-motion]="reducedMotion()"
  role="region"
  aria-labelledby="history-trend-title"
  aria-live="polite"
>
  <h4 id="history-trend-title" class="history-title">
    Recent Trend (Last {{ historySignal().length }} Changes)
  </h4>

  <!-- Sparkline Charts Grid -->
  <div class="sparklines-grid">
    <!-- Accuracy Gain Sparkline -->
    <div class="sparkline-container">
      <div class="sparkline-header">
        <span class="sparkline-label">Accuracy Gain</span>
        <span class="sparkline-unit">%</span>
      </div>
      <svg
        class="sparkline"
        [attr.width]="120"
        [attr.height]="40"
        viewBox="0 0 120 40"
        preserveAspectRatio="none"
        role="img"
        [attr.aria-label]="summary().accuracy"
      >
        <path
          class="sparkline-path accuracy-path"
          [attr.d]="accuracyPath()"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          vector-effect="non-scaling-stroke"
        />
        <!-- Add circle markers for color-blind accessibility -->
        <circle
          *ngFor="let sample of historySignal(); let i = index"
          class="sparkline-marker"
          [attr.cx]="4 + (i * (112 / Math.max(1, historySignal().length - 1)))"
          [attr.cy]="20"
          r="2"
          fill="currentColor"
        />
      </svg>
    </div>

    <!-- Latency Difference Sparkline -->
    <div class="sparkline-container">
      <div class="sparkline-header">
        <span class="sparkline-label">Latency Diff</span>
        <span class="sparkline-unit">ms</span>
      </div>
      <svg
        class="sparkline"
        [attr.width]="120"
        [attr.height]="40"
        viewBox="0 0 120 40"
        preserveAspectRatio="none"
        role="img"
        [attr.aria-label]="summary().latency"
      >
        <path
          class="sparkline-path latency-path"
          [attr.d]="latencyPath()"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          vector-effect="non-scaling-stroke"
        />
        <!-- Add square markers for color-blind accessibility -->
        <rect
          *ngFor="let sample of historySignal(); let i = index"
          class="sparkline-marker"
          [attr.x]="(4 + (i * (112 / Math.max(1, historySignal().length - 1)))) - 2"
          [attr.y]="18"
          width="4"
          height="4"
          fill="currentColor"
        />
      </svg>
    </div>

    <!-- Violation Reduction Sparkline -->
    <div class="sparkline-container">
      <div class="sparkline-header">
        <span class="sparkline-label">Violation Reduction</span>
        <span class="sparkline-unit">%</span>
      </div>
      <svg
        class="sparkline"
        [attr.width]="120"
        [attr.height]="40"
        viewBox="0 0 120 40"
        preserveAspectRatio="none"
        role="img"
        [attr.aria-label]="summary().violations"
      >
        <path
          class="sparkline-path violations-path"
          [attr.d]="violationPath()"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          vector-effect="non-scaling-stroke"
        />
        <!-- Add diamond markers for color-blind accessibility -->
        <polygon
          *ngFor="let sample of historySignal(); let i = index"
          class="sparkline-marker"
          [attr.points]="
            getMarkerPoints(4 + (i * (112 / Math.max(1, historySignal().length - 1))), 20, 3)
          "
          fill="currentColor"
        />
      </svg>
    </div>
  </div>

  <!-- Visually-hidden data table for screen readers -->
  <table class="sr-only" aria-label="Historical metrics data table">
    <thead>
      <tr>
        <th>Change #</th>
        <th>Accuracy Gain (%)</th>
        <th>Latency Diff (ms)</th>
        <th>Violation Reduction (%)</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let sample of historySignal(); let i = index">
        <td>{{ i + 1 }}</td>
        <td>{{ formatValue(sample.accuracyDelta) }}</td>
        <td>{{ formatValue(sample.latencyDeltaMs, 0) }}</td>
        <td>{{ formatValue(sample.violationReduction) }}</td>
      </tr>
    </tbody>
  </table>

  <!-- Legend -->
  <div class="legend" role="region" aria-label="Chart legend">
    <div class="legend-item">
      <span class="legend-marker accuracy-marker" aria-hidden="true"></span>
      <span class="legend-label">Accuracy Gain (circle)</span>
    </div>
    <div class="legend-item">
      <span class="legend-marker latency-marker" aria-hidden="true"></span>
      <span class="legend-label">Latency Diff (square)</span>
    </div>
    <div class="legend-item">
      <span class="legend-marker violations-marker" aria-hidden="true"></span>
      <span class="legend-label">Violation Reduction (diamond)</span>
    </div>
  </div>
</section>
