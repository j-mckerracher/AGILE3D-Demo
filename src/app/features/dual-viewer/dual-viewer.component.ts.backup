import { Component, Input, OnInit, OnChanges, SimpleChanges, OnDestroy, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { SceneViewerComponent } from '../scene-viewer/scene-viewer.component';
import { Detection } from '../../core/models/scene.models';
import { DiffMode } from '../../core/services/visualization/bbox-instancing';
import * as THREE from 'three';
import { Subscription } from 'rxjs';
import { MatButtonModule } from '@angular/material/button';
import { MatIconModule } from '@angular/material/icon';
import { MatSliderModule } from '@angular/material/slider';
import { MatTooltipModule } from '@angular/material/tooltip';
import { FrameStreamService } from '../../core/services/frame-stream/frame-stream.service';

/**
 * DualViewer displays two synchronized SceneViewer instances side-by-side.
 *
 * Features (WP-2.1.1):
 * - Two viewers ('baseline' and 'agile3d') with synchronized cameras via StateService
 * - Shared point cloud geometry for memory efficiency (single GPU buffer)
 * - Optional per-viewer detections for comparison
 * - Scene switching crossfade transition ≤500ms
 *
 * Camera synchronization is automatic via CameraControlService attached in each SceneViewer.
 * Geometry is sourced from SceneDataService.loadPointsObject() to ensure a single shared instance.
 *
 * @example
 * <app-dual-viewer
 *   [inputPoints]="sharedPoints"
 *   [baselineDetections]="baselineDetections"
 *   [agile3dDetections]="agile3dDetections"
 * />
 *
 * @see WP-2.1.1 Dual Viewer Foundation (Shared Geometry)
 * @see SceneDataService.loadPointsObject
 */
@Component({
  selector: 'app-dual-viewer',
  standalone: true,
  imports: [
    CommonModule,
    SceneViewerComponent,
  ],
  templateUrl: './dual-viewer.component-new.html',
  styleUrls: ['./dual-viewer.component-new.scss'],
})
    <div class="dual-viewer-container">
      <!-- Small Legend Overlay -->
      <aside class="legend-overlay" aria-label="Detection legend">
        <header class="legend-title">Legend</header>
        <ul class="legend-list">
          <li class="legend-row">
            <span class="legend-swatch swatch-vehicle" aria-hidden="true"></span>
            <span class="legend-text">Vehicle</span>
          </li>
          <li class="legend-row">
            <span class="legend-swatch swatch-pedestrian" aria-hidden="true"></span>
            <span class="legend-text">Pedestrian</span>
          </li>
          <li class="legend-row">
            <span class="legend-swatch swatch-cyclist" aria-hidden="true"></span>
            <span class="legend-text">Cyclist</span>
          </li>
          <li class="legend-row">
            <span class="legend-swatch swatch-fp" aria-hidden="true"></span>
            <span class="legend-text">False Positive</span>
          </li>
        </ul>
      </aside>

      <!-- Baseline Viewer Region (NFR-3.3, NFR-3.4) -->
      <section
        class="viewer-panel"
        [class.active]="activeViewer === 'baseline'"
        [class.inactive]="activeViewer !== 'baseline'"
        role="region"
        aria-labelledby="baseline-viewer-label"
        [attr.aria-hidden]="activeViewer !== 'baseline'"
      >
        <header class="viewer-header" id="baseline-viewer-label">
          <div class="viewer-title">
            <h2 class="viewer-heading">{{ leftTitle }}</h2>
            <span class="viewer-subtitle">Baseline detections</span>
          </div>
          <div class="viewer-meta" aria-label="Baseline detection count">
            {{ baselineDetections.length || 0 }} boxes
          </div>
        </header>
        <app-scene-viewer
          viewerId="baseline"
          [sharedPointGeometry]="sharedGeometry"
          [detections]="baselineDetections"
          [diffMode]="effectiveDiffMode"
          [diffClassification]="baselineDiffClassification"
          [paneLabel]="'Baseline'"
          [showFps]="showFps"
        />
      </section>

      <!-- Crossfade Toggle Button (WP-2.1.1) -->
      <button
        class="crossfade-toggle"
        type="button"
        (click)="toggleActiveViewer()"
        [disabled]="isTransitioning"
        [attr.aria-label]="
          'Switch to ' + (activeViewer === 'baseline' ? 'AGILE3D' : 'Baseline') + ' viewer'
        "
        [attr.aria-pressed]="activeViewer === 'agile3d'"
      >
        <span class="toggle-icon" aria-hidden="true">⇄</span>
        <span class="toggle-text">
          {{ activeViewer === 'baseline' ? 'Show AGILE3D' : 'Show Baseline' }}
        </span>
      </button>

      <!-- Camera Sync Controls (WP-2.1.3) -->
      <!-- COMMENTED OUT: Independent camera feature disabled
      <div class="camera-controls-container">
        <app-camera-sync-controls />
      </div>
      -->

      <!-- FP Only Toggle -->
      <button
        class="fp-toggle"
        type="button"
        (click)="toggleFPOnly()"
        [attr.aria-pressed]="effectiveDiffMode === 'fp'"
        aria-label="Toggle show only false positives"
        title="Show only false positives"
      >
        FP Only: {{ effectiveDiffMode === 'fp' ? 'On' : 'Off' }}
      </button>

      <!-- Playback Controls Overlay -->
      <div class="playback-overlay" aria-label="Playback controls">
        <div class="playback-buttons">
          <!-- Step Backward -->
          <button
            mat-icon-button
            (click)="onStepBackward()"
            [disabled]="isStopped || isPlaying || currentFrameIndex === 0"
            matTooltip="Previous Frame"
            aria-label="Previous frame">
            <mat-icon>skip_previous</mat-icon>
          </button>

          <!-- Play/Pause Toggle -->
          <button
            mat-icon-button
            (click)="onPlayPause()"
            [disabled]="isStopped"
            [class.playing]="isPlaying"
            [matTooltip]="isStopped ? 'Load a scene to play' : (isPlaying ? 'Pause' : 'Play')"
            [attr.aria-label]="isStopped ? 'Playback unavailable' : (isPlaying ? 'Pause playback' : 'Play playback')">
            <mat-icon>{{ isPlaying ? 'pause' : 'play_arrow' }}</mat-icon>
          </button>

          <!-- Step Forward -->
          <button
            mat-icon-button
            (click)="onStepForward()"
            [disabled]="isStopped || isPlaying || currentFrameIndex === totalFrames - 1"
            matTooltip="Next Frame"
            aria-label="Next frame">
            <mat-icon>skip_next</mat-icon>
          </button>
        </div>

        <!-- Frame Counter -->
        <div class="frame-counter">
          <span aria-live="polite">Frame {{ currentFrameIndex + 1 }} / {{ totalFrames }}</span>
        </div>

        <!-- Seek Slider -->
        <div class="seek-slider">
          <mat-slider
            [min]="0"
            [max]="totalFrames - 1"
            [step]="1"
            [discrete]="true"
            aria-label="Seek through frames">
            <input matSliderThumb [value]="currentFrameIndex" (input)="onSeek(+$event.target.value)" />
          </mat-slider>
        </div>
      </div>

      <!-- Ground Truth Toggle (Placeholder for future WP) -->
      <!-- COMMENTED OUT: GT button removed
      <button
        class="gt-toggle"
        type="button"
        [disabled]="true"
        title="Ground Truth overlay (Coming soon)"
        aria-label="Toggle ground truth overlay (not yet implemented)"
      >
        <span class="toggle-icon" aria-hidden="true">GT</span>
        <span class="toggle-text">Ground Truth</span>
      </button>
      -->

      <!-- AGILE3D Viewer Region (NFR-3.3, NFR-3.4) -->
      <section
        class="viewer-panel"
        [class.active]="activeViewer === 'agile3d'"
        [class.inactive]="activeViewer !== 'agile3d'"
        role="region"
        aria-labelledby="agile3d-viewer-label"
        [attr.aria-hidden]="activeViewer !== 'agile3d'"
      >
        <header class="viewer-header" id="agile3d-viewer-label">
          <div class="viewer-title">
            <h2 class="viewer-heading">{{ rightTitle }}</h2>
            <span class="viewer-subtitle">AGILE3D detections</span>
          </div>
          <div class="viewer-meta" aria-label="AGILE3D detection count">
            {{ agile3dDetections.length || 0 }} boxes
          </div>
        </header>
        <app-scene-viewer
          viewerId="agile3d"
          [sharedPointGeometry]="sharedGeometry"
          [detections]="agile3dDetections"
          [diffMode]="effectiveDiffMode"
          [diffClassification]="agile3dDiffClassification"
          [paneLabel]="'AGILE3D'"
          [showFps]="showFps"
        />
        <div class="no-dets-overlay" *ngIf="!agile3dDetections || agile3dDetections.length === 0">
          No detections for {{ rightTitle }}
        </div>
      </section>
    </div>
  `,
  styles: [
    `
      :host {
        display: flex;
        width: 90%;
        height: 100%;
        margin: 0 auto;
        box-sizing: border-box;
      }

      .dual-viewer-container {
        display: flex;
        width: 100%;
        height: 100%;
        gap: 1%;
        background: #1a1a1a;
        position: relative;
      }

      .viewer-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        min-width: 0;
        max-width: 49.5%;
        opacity: 1;
        transition: opacity var(--ag3d-duration-slower, 500ms) var(--ag3d-easing-standard, ease);
      }

      /* Crossfade states (WP-2.1.1) */
      .viewer-panel.active {
        opacity: 1;
        pointer-events: auto;
      }

      .viewer-panel.inactive {
        opacity: 0.3;
        pointer-events: none;
      }

      /* Crossfade Toggle Button (WP-2.1.1) */
      .crossfade-toggle {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1002;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 12px 20px;
        background: rgba(0, 0, 0, 0.9);
        color: #fff;
        border: 2px solid #4a9eff;
        border-radius: 8px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--ag3d-duration-fast, 100ms) var(--ag3d-easing-standard, ease);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }

      .crossfade-toggle:hover:not(:disabled) {
        background: rgba(74, 158, 255, 0.2);
        border-color: #6bb1ff;
        transform: translate(-50%, -50%) scale(1.05);
      }

      .crossfade-toggle:active:not(:disabled) {
        transform: translate(-50%, -50%) scale(0.98);
      }

      .crossfade-toggle:focus-visible {
        outline: 2px solid var(--ag3d-color-focus, #4a9eff);
        outline-offset: 2px;
      }

      .crossfade-toggle:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .toggle-icon {
        font-size: 24px;
        line-height: 1;
      }

      .toggle-text {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .viewer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px 8px 16px;
        color: #f4f7fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .viewer-title {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .viewer-heading {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        letter-spacing: 0.35px;
      }

      .viewer-subtitle {
        font-size: 12px;
        font-weight: 500;
        opacity: 0.75;
      }

      .viewer-meta {
        font-size: 12px;
        font-weight: 600;
        opacity: 0.85;
      }

      /* Legend overlay */
      .legend-overlay {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(10, 12, 18, 0.85);
        color: #f6f8fb;
        padding: 16px 18px;
        border-radius: 10px;
        font-size: 12px;
        z-index: 1003;
        min-width: 180px;
        border: 1px solid rgba(255,255,255,0.08);
        box-shadow: 0 8px 24px rgba(0,0,0,0.45);
      }
      .legend-title {
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        opacity: 0.85;
      }
      .legend-list {
        list-style: none;
        padding: 0;
        margin: 10px 0 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .legend-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .legend-text {
        font-size: 12px;
        font-weight: 500;
        opacity: 0.9;
      }
      .legend-swatch {
        width: 18px;
        height: 12px;
        border: 2px solid currentColor;
        border-radius: 2px;
        background: currentColor;
        opacity: 0.85;
      }
      .swatch-vehicle { color: var(--ag3d-color-class-vehicle); }
      .swatch-pedestrian { color: var(--ag3d-color-class-pedestrian); }
      .swatch-cyclist { color: var(--ag3d-color-class-cyclist); }
      .swatch-fp { color: #ff3b30; }

      .camera-controls-container {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1003;
      }

      /* FP Only Toggle */
      .fp-toggle {
        position: absolute;
        top: 16px;
        right: 214px;
        z-index: 1003;
        padding: 6px 12px;
        background: rgba(10,12,18,0.85);
        color: #f6f8fb;
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 8px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        letter-spacing: 0.05em;
        transition: background 120ms ease;
      }

      .fp-toggle:hover {
        background: rgba(74, 158, 255, 0.2);
      }

      /* Ground Truth Toggle (Placeholder) */
      /* COMMENTED OUT: GT button styles removed
      .gt-toggle {
        position: absolute;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1002;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 8px 16px;
        background: rgba(0, 0, 0, 0.7);
        color: #999;
        border: 2px solid #555;
        border-radius: 6px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 11px;
        font-weight: 600;
        cursor: not-allowed;
        opacity: 0.5;
      }

      .gt-toggle .toggle-icon {
        font-size: 14px;
        line-height: 1;
      }

      .gt-toggle .toggle-text {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      */

      .no-dets-overlay {
        position: absolute;
        top: 80px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 6px 10px;
        font-size: 12px;
        border-radius: 4px;
        z-index: 1001;
      }

      /* Playback Controls Overlay */
      .playback-overlay {
        position: absolute;
        top: 16px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1002;
        background: rgba(10, 12, 18, 0.85);
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }

      .playback-buttons {
        display: flex;
        justify-content: center;
        gap: 8px;
      }

      .playback-buttons button {
        &:disabled {
          opacity: 0.4;
        }

        &.playing {
          color: var(--md-sys-color-primary, #4a9eff);
        }
      }

      .frame-counter {
        text-align: center;
        font-size: 0.875rem;
        color: #f6f8fb;
        opacity: 0.8;
        font-family: monospace;
      }

      .seek-slider {
        width: 100%;

        mat-slider {
          width: 100%;
        }
      }

      app-scene-viewer {
        flex: 1;
        display: block;
      }

      /* Reduced Motion Support (WP-2.1.1, NFR-3.7) */
      @media (prefers-reduced-motion: reduce) {
        .viewer-panel {
          transition-duration: 0.01ms !important;
        }

        .crossfade-toggle {
          transition-duration: 0.01ms !important;
        }
      }

      /* Responsive breakpoints */
      /* Tablet breakpoint - Stack viewers at 1024x768 per PRD UI §8.1.2 */
      @media (max-width: 1024px) {
        :host {
          width: 95%;
        }

        .dual-viewer-container {
          flex-direction: column;
          gap: 12px;
        }

        .viewer-panel {
          max-width: 100%;
          height: 350px; /* Adjusted for ~768px tall displays */
        }

        .crossfade-toggle {
          top: 50%;
          left: 50%;
        }

        .legend-overlay {
          top: 16px;
          right: 16px;
        }

        .fp-toggle {
          top: 16px;
          right: 16px;
          transform: translateY(48px);
        }

        .camera-controls-container {
          top: 12px;
        }

        .gt-toggle {
          top: 80px;
        }
      }

      /* Mobile optimization */
      @media (max-width: 768px) {
        :host {
          width: 100%;
        }

        .viewer-panel {
          height: 400px;
        }

        .crossfade-toggle {
          padding: 10px 16px;
          font-size: 12px;
        }

        .toggle-icon {
          font-size: 20px;
        }

        .toggle-text {
          font-size: 10px;
        }

        .legend-overlay {
          position: static;
          width: auto;
          margin: 0 auto 12px;
          order: -1;
        }

        .fp-toggle {
          top: 12px;
          right: 16px;
          transform: translateY(44px);
        }

        .camera-controls-container {
          top: 8px;
          left: 50%;
          transform: translateX(-50%) scale(0.9);
        }

        .gt-toggle {
          top: 70px;
        }
      }
    `,
  ],
})
export class DualViewerComponent implements OnInit, OnChanges, OnDestroy {
  /** Detections to display in the baseline viewer */
  @Input() public baselineDetections: Detection[] = [];

  /** Detections to display in the AGILE3D viewer */
  @Input() public agile3dDetections: Detection[] = [];

  /** Diff mode for visual encoding (TP/FP/FN highlighting) */
  @Input() public diffMode: DiffMode = 'all';

  /** Effective diff mode used internally and toggleable */
  protected effectiveDiffMode: DiffMode = 'all';

  // Playback controls state
  protected isPlaying = false;
  protected isPaused = false;
  protected isStopped = false;
  protected currentFrameIndex = 0;
  protected totalFrames = 0;
  private statusSubscription?: Subscription;
  private frameSubscription?: Subscription;
  private readonly frameStream = inject(FrameStreamService);

  /** Optional: diff classification map (detection ID -> 'tp'|'fp'|'fn') */
  @Input() public baselineDiffClassification?: Map<string, 'tp' | 'fp' | 'fn'>;

  /** Optional: diff classification map for AGILE3D viewer */
  @Input() public agile3dDiffClassification?: Map<string, 'tp' | 'fp' | 'fn'>;

  /** Panel titles */
  @Input() public leftTitle: string = 'Baseline';
  @Input() public rightTitle: string = 'AGILE3D';

  /** Show ground truth overlay (placeholder for future WP) */
  @Input() public showGroundTruth = false;

  /** Number of points in synthetic point cloud (default 50k) */
  @Input() public pointCount = 50_000;

  /** Optional externally provided shared Points instance (from SceneDataService, WP-2.1.1) */
  @Input() public inputPoints?: THREE.Points;

  /** @deprecated Use inputPoints instead. Optional externally provided shared point geometry. */
  @Input() public inputGeometry?: THREE.BufferGeometry;

  /** Show FPS overlay on both viewers */
  @Input() public showFps = true;

  /** Shared point cloud geometry for both viewers (extracted from Points or created on init) */
  protected sharedGeometry!: THREE.BufferGeometry;

  /** Active viewer for crossfade demonstration ('baseline' | 'agile3d') */
  protected activeViewer: 'baseline' | 'agile3d' = 'baseline';

  /** Whether a crossfade transition is currently in progress */
  protected isTransitioning = false;
  private lastToggleTimestamp?: number;

  public ngOnInit(): void {
    this.effectiveDiffMode = this.diffMode;
    // Priority: inputPoints > inputGeometry > synthetic
    if (this.inputPoints) {
      console.log('[DualViewer] using external Points instance (WP-2.1.1)', {
        uuid: this.inputPoints.geometry.uuid,
        vertices: this.inputPoints.geometry.getAttribute('position')?.count ?? 0,
      });
      this.sharedGeometry = this.inputPoints.geometry as THREE.BufferGeometry;
    } else if (this.inputGeometry) {
      console.log('[DualViewer] using external geometry (deprecated path)');
      this.sharedGeometry = this.inputGeometry;
    } else {
      console.log('[DualViewer] creating synthetic geometry');
      this.sharedGeometry = this.createSharedPointCloud(this.pointCount);
    }

    // Subscribe to playback status
    this.statusSubscription = this.frameStream.status$.subscribe(status => {
      this.isPlaying = status === 'playing';
      this.isPaused = status === 'paused';
      this.isStopped = status === 'stopped';
    });

    // Subscribe to current frame for counter and slider
    // Also update totalFrames reactively when manifest becomes available
    this.frameSubscription = this.frameStream.currentFrame$.subscribe(frame => {
      if (frame) {
        this.currentFrameIndex = frame.index;
        // Update totalFrames from service when frame available
        const total = this.frameStream.getTotalFrames();
        if (total > 0 && this.totalFrames !== total) {
          this.totalFrames = total;
        }
      }
    });
  }

  public ngOnChanges(changes: SimpleChanges): void {
    if (changes['diffMode'] && changes['diffMode'].currentValue) {
      this.effectiveDiffMode = changes['diffMode'].currentValue;
    }
    if (changes['inputPoints'] && this.inputPoints) {
      // Switch to external shared Points geometry when it becomes available
      console.log('[DualViewer] switching to external Points geometry', {
        uuid: this.inputPoints.geometry.uuid,
        vertices: this.inputPoints.geometry.getAttribute('position')?.count ?? 0,
      });
      this.sharedGeometry = this.inputPoints.geometry as THREE.BufferGeometry;
    }
  }

  public ngOnDestroy(): void {
    this.statusSubscription?.unsubscribe();
    this.frameSubscription?.unsubscribe();
  }

  /**
   * Toggle between baseline and AGILE3D viewers with crossfade effect.
   *
   * Implements visual crossfade transition ≤500ms per WP-2.1.1 requirements.
   * The transition respects prefers-reduced-motion for accessibility.
   * Both viewers continue rendering during the fade to prevent visual jumps.
   */
  protected toggleActiveViewer(): void {
    if (this.isTransitioning) {
      // Allow a second immediate toggle if a transition was initiated by this component
      if (this.lastToggleTimestamp === undefined) {
        console.log('[DualViewer] crossfade in progress, ignoring toggle');
        return;
      }
    }

    this.isTransitioning = true;
    const nextViewer = this.activeViewer === 'baseline' ? 'agile3d' : 'baseline';
    this.lastToggleTimestamp = performance.now();

    console.log('[DualViewer] crossfade transition', {
      from: this.activeViewer,
      to: nextViewer,
    });

    // Update active viewer immediately (CSS handles the transition)
    this.activeViewer = nextViewer;

    // Reset transition flag after animation completes (500ms + 50ms buffer)
    setTimeout(() => {
      this.isTransitioning = false;
      this.lastToggleTimestamp = undefined;
      console.log('[DualViewer] crossfade complete');
    }, 550);
  }

  /**
   * Create a single shared BufferGeometry for both viewers.
   * This ensures memory efficiency and consistent point cloud across views.
   */
  private createSharedPointCloud(count: number): THREE.BufferGeometry {
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(count * 3);

    // Generate random points in a 20x20x5 volume
    for (let i = 0; i < count; i++) {
      const i3 = i * 3;
      positions[i3] = (Math.random() - 0.5) * 20; // x: -10 to 10
      positions[i3 + 1] = (Math.random() - 0.5) * 20; // y: -10 to 10
      positions[i3 + 2] = Math.random() * 5; // z: 0 to 5
    }

    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    return geometry;
  }

  /** Toggle diff mode between 'all' and 'fp' for quick debugging */
  protected toggleFPOnly(): void {
    this.effectiveDiffMode = this.effectiveDiffMode === 'fp' ? 'all' : 'fp';
  }

  // Playback control methods
  protected onPlayPause(): void {
    if (this.isPlaying) {
      this.frameStream.pause();
    } else if (this.isPaused) {
      this.frameStream.resume();
    }
    // If stopped, manifest hasn't been loaded yet - button should be disabled
  }

  protected onSeek(frameIndex: number): void {
    // Pause during manual seeking
    if (this.isPlaying) {
      this.frameStream.pause();
    }
    this.frameStream.seek(frameIndex);
  }

  protected onStepForward(): void {
    const nextIndex = Math.min(this.currentFrameIndex + 1, this.totalFrames - 1);
    this.frameStream.seek(nextIndex);
  }

  protected onStepBackward(): void {
    const prevIndex = Math.max(this.currentFrameIndex - 1, 0);
    this.frameStream.seek(prevIndex);
  }
}
